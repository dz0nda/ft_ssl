/* ************************************************************************** */
/*                                                                            */
/*                                                        :::      ::::::::   */
/*   ft_base64_decode.c                                 :+:      :+:    :+:   */
/*                                                    +:+ +:+         +:+     */
/*   By: dzonda <dzonda@student.42lyon.fr>          +#+  +:+       +#+        */
/*                                                +#+#+#+#+#+   +#+           */
/*   Created: 2019/11/19 12:18:59 by dzonda            #+#    #+#             */
/*   Updated: 2021/07/21 20:51:22 by dzonda           ###   ########lyon.fr   */
/*                                                                            */
/* ************************************************************************** */

#include "ft_base64.h"

static const t_uchar b64_decode[256] = {
    66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 64, 66, 66, 66, 66, 66, 66, 66, 66,
    66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66,
    66, 66, 66, 66, 66, 62, 66, 66, 66, 63, 52, 53, 54, 55, 56, 57, 58, 59, 60,
    61, 66, 66, 66, 65, 66, 66, 66, 0,  1,  2,  3,  4,  5,  6,  7,  8,  9,  10,
    11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 66, 66, 66, 66,
    66, 66, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42,
    43, 44, 45, 46, 47, 48, 49, 50, 51, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66,
    66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66,
    66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66,
    66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66,
    66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66,
    66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66,
    66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66,
    66, 66, 66, 66, 66, 66, 66, 66, 66
  };

void  ft_b64_dec_block(unsigned char *dst, t_uint32 block, int i, int *idst) {
  if (!(i % 4)) {
    dst[(*idst)++] = (t_uchar)(block >> 16) & 255;
    dst[(*idst)++] = (t_uchar)(block >> 8) & 255;
    dst[(*idst)++] = (t_uchar)block & 255;
  } else if (i % 4 == 3) {
    dst[(*idst)++] = (t_uchar)(block >> 10) & 255;
    dst[(*idst)++] = (t_uchar)(block >> 2) & 255;
  } else if (i % 4 == 3) {
    dst[(*idst)++] = (t_uchar)(block >> 4) & 255;
  }
}

void ft_b64_dec(unsigned char *dst, size_t dst_len, unsigned char *src, size_t src_len) {
  uint32_t block = 0;
  int i = 0;
  int idst = 0;
  unsigned char c = 66;

  while (i < src_len) {
    c = b64_decode[src[i]];
  
    if (c == 65) break;
  
    block = block << 6 | (t_uchar)b64_decode[src[i]];

    i += 1;

    if (!(i % 4)) {
      ft_b64_dec_block(dst, block, i, &idst);
      block = 0;
    }
  }

  if (i % 4)
    ft_b64_dec_block(dst, block, i, &idst);
}
